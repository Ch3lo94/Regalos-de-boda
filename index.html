<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Regalos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .regalo {
      padding: 15px;
      margin: 10px 0;
      background: white;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 20px;
      border: 1px solid #ddd;
    }

    .regalo img {
      width: 120px;
      height: auto;
      border-radius: 5px;
    }

    .agotado {
      opacity: 0.5;
      pointer-events: none;
      background: #d0d0d0;
    }

    button {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      background: #0077ff;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    button:disabled {
      background: gray;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <h2>Selecciona tu regalo üéÅ</h2>

  <div id="contenedor"></div>

  <button id="btnEnviar">Enviar</button>

  <script>
    let usuario = null;
    let regalos = [];
    let seleccion = [];

    // =============================
    //  LOGIN GOOGLE
    // =============================
    google.accounts.id.initialize({
      client_id: "342769047778-jc52eh3n59a3vjocagmomi8pln5kbqv3.apps.googleusercontent.com",
      callback: handleCredentialResponse
    });
    google.accounts.id.prompt();

    function handleCredentialResponse(response) {
      const payload = JSON.parse(atob(response.credential.split('.')[1]));

      const partes = payload.name.split(" ");
      usuario = {
        nombre: partes[0],
        apellido: partes.slice(1).join(" "),
        email: payload.email
      };

      cargarRegalos();
    }

    // =============================
    // CARGAR REGALOS DEL SERVIDOR
    // =============================
    async function cargarRegalos() {
      const r = await fetch("exec_url_aqui?list=1");
      regalos = await r.json();
      mostrar();
    }

    function mostrar() {
      const div = document.getElementById("contenedor");
      div.innerHTML = "";

      regalos.forEach(r => {
        const caja = document.createElement("div");
        caja.className = "regalo";
        if (r.stock <= 0) caja.classList.add("agotado");

        caja.innerHTML = `
          <img src="${r.imagen}" />
          <div>
            <h3>${r.nombre}</h3>
            <p>${r.descripcion}</p>
            <button 
             ${r.stock <= 0 ? "disabled" : ""}
             onclick="toggle(${r.id})">
             Seleccionar
            </button>
          </div>
        `;

        div.appendChild(caja);
      });
    }

    function toggle(id) {
      if (seleccion.includes(id)) {
        seleccion = seleccion.filter(x => x !== id);
      } else {
        seleccion.push(id);
      }
    }

    // =============================
    // ENVIAR FORMULARIO
    // =============================
    document.getElementById("btnEnviar").onclick = async () => {
      if (seleccion.length === 0) {
        alert("Debes elegir al menos un regalo.");
        return;
      }

      const r = await fetch("https://script.google.com/macros/s/AKfycbxuABiOY1J8S8ntmJ0TAfzHHvFvO6y3qiC34dPfG4g-qSg8gFj__hx-2EkotUO4RYDj/exec", {
        method: "POST",
        body: JSON.stringify({
          nombre: usuario.nombre,
          apellido: usuario.apellido,
          email: usuario.email,
          seleccion
        })
      });

      const data = await r.json();

      if (data.error === "email_ya_usado") {
        alert("‚ùó Ya registraste un regalo con este correo.");
        return;
      }

      if (data.success) {
        alert("¬°Gracias! Tu elecci√≥n fue guardada ‚ù§Ô∏è");
        location.reload();
      }
    };
  </script>

</body>
</html>
